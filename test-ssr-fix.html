<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSRä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }
        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            overflow-x: auto;
        }
        .fix-item {
            margin: 10px 0;
            padding: 10px;
            border-left: 4px solid #007bff;
            background: #f8f9fa;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ SSRä¿®å¤æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>é—®é¢˜æè¿°</h2>
        <div class="status error">
            <strong>åŸå§‹é”™è¯¯:</strong><br>
            âŒ TypeError: Please use the 'new' operator, this DOM object constructor cannot be called as a function.<br>
            âŒ åœ¨æœåŠ¡å™¨ç«¯æ¸²æŸ“æ—¶è®¿é—®æµè§ˆå™¨APIå¯¼è‡´é”™è¯¯<br>
            âŒ localStorageã€documentã€windowç­‰APIåœ¨æœåŠ¡å™¨ç«¯ä¸å¯ç”¨
        </div>
    </div>

    <div class="test-section">
        <h2>ä¿®å¤å†…å®¹</h2>
        
        <div class="fix-item">
            <strong>1. ä¿®å¤URLæ„é€ å‡½æ•°ä½¿ç”¨</strong><br>
            <div class="code-block">
// ä¿®æ”¹å‰
const downloadUrl = window.URL.createObjectURL(blob)

// ä¿®æ”¹å  
const downloadUrl = URL.createObjectURL(blob)
            </div>
            <p>ä½¿ç”¨å…¨å±€URLå¯¹è±¡è€Œä¸æ˜¯window.URL</p>
        </div>

        <div class="fix-item">
            <strong>2. ä¿®å¤localStorageè®¿é—®</strong><br>
            <div class="code-block">
// ä¿®æ”¹å‰
const savedToken = localStorage.getItem("token")

// ä¿®æ”¹å
if (typeof window !== 'undefined') {
  const savedToken = localStorage.getItem("token")
}
            </div>
            <p>åªåœ¨å®¢æˆ·ç«¯è®¿é—®localStorage</p>
        </div>

        <div class="fix-item">
            <strong>3. ä¿®å¤documentè®¿é—®</strong><br>
            <div class="code-block">
// ä¿®æ”¹å‰
document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`

// ä¿®æ”¹å
if (typeof document !== 'undefined') {
  document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`
}
            </div>
            <p>åªåœ¨å®¢æˆ·ç«¯è®¾ç½®cookie</p>
        </div>

        <div class="fix-item">
            <strong>4. ä¿®å¤windowäº‹ä»¶ç›‘å¬å™¨</strong><br>
            <div class="code-block">
// ä¿®æ”¹å‰
useEffect(() => {
  window.addEventListener('mousemove', handleMouseMove)
  return () => window.removeEventListener('mousemove', handleMouseMove)
}, [])

// ä¿®æ”¹å
useEffect(() => {
  if (typeof window === 'undefined') return
  
  window.addEventListener('mousemove', handleMouseMove)
  return () => window.removeEventListener('mousemove', handleMouseMove)
}, [])
            </div>
            <p>åªåœ¨å®¢æˆ·ç«¯æ·»åŠ äº‹ä»¶ç›‘å¬å™¨</p>
        </div>

        <div class="fix-item">
            <strong>5. ä¿®å¤window.locationè®¿é—®</strong><br>
            <div class="code-block">
// ä¿®æ”¹å‰
return `${window.location.origin}/share/${share.shareToken}`

// ä¿®æ”¹å
if (typeof window !== 'undefined') {
  return `${window.location.origin}/share/${share.shareToken}`
}
return `/share/${share.shareToken}`
            </div>
            <p>åªåœ¨å®¢æˆ·ç«¯è®¿é—®window.location</p>
        </div>
    </div>

    <div class="test-section">
        <h2>ä¿®å¤çš„æ–‡ä»¶</h2>
        <div class="code-block">
ä¿®å¤çš„æ–‡ä»¶åˆ—è¡¨:
- lib/utils.ts (URLæ„é€ å‡½æ•°)
- components/auth/auth-provider.tsx (localStorage)
- components/ui/sidebar.tsx (document.cookie, windowäº‹ä»¶)
- app/page.tsx (windowäº‹ä»¶ç›‘å¬å™¨)
- app/shares/page.tsx (window.location)
- test-download.html (URLæ„é€ å‡½æ•°)
- test-download-cors.html (URLæ„é€ å‡½æ•°)
- test-cors-fix.html (URLæ„é€ å‡½æ•°)
        </div>
    </div>

    <div class="test-section">
        <h2>æµ‹è¯•æ­¥éª¤</h2>
        <div class="status info">
            <strong>éªŒè¯æ­¥éª¤:</strong><br>
            1. é‡å¯å‰ç«¯å¼€å‘æœåŠ¡å™¨<br>
            2. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜<br>
            3. è®¿é—®åº”ç”¨é¦–é¡µ<br>
            4. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯<br>
            5. æµ‹è¯•ç™»å½•/æ³¨å†ŒåŠŸèƒ½<br>
            6. æµ‹è¯•æ–‡ä»¶ä¸‹è½½åŠŸèƒ½<br>
            7. æµ‹è¯•R2æŒ‚è½½åŠŸèƒ½<br>
            8. éªŒè¯æ‰€æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ
        </div>
    </div>

    <div class="test-section">
        <h2>ä¿®å¤çŠ¶æ€</h2>
        <div class="status success">
            <strong>ä¿®å¤å®Œæˆ:</strong><br>
            âœ… 1. URLæ„é€ å‡½æ•°ä½¿ç”¨å·²ä¿®å¤<br>
            âœ… 2. localStorageè®¿é—®å·²ä¿®å¤<br>
            âœ… 3. documentè®¿é—®å·²ä¿®å¤<br>
            âœ… 4. windowäº‹ä»¶ç›‘å¬å™¨å·²ä¿®å¤<br>
            âœ… 5. window.locationè®¿é—®å·²ä¿®å¤<br>
            ğŸ”„ 6. ç­‰å¾…å®é™…æµ‹è¯•éªŒè¯...
        </div>
    </div>

    <div class="test-section">
        <h2>æŠ€æœ¯åŸç†</h2>
        <div class="code-block">
SSR (Server-Side Rendering) é—®é¢˜:
- Next.jsåœ¨æœåŠ¡å™¨ç«¯é¢„æ¸²æŸ“é¡µé¢
- æœåŠ¡å™¨ç«¯æ²¡æœ‰æµè§ˆå™¨API (window, document, localStorageç­‰)
- éœ€è¦æ£€æŸ¥ typeof window !== 'undefined' æ¥åŒºåˆ†ç¯å¢ƒ
- ä½¿ç”¨ 'use client' æŒ‡ä»¤æ ‡è®°å®¢æˆ·ç«¯ç»„ä»¶
- åœ¨useEffectä¸­å®‰å…¨åœ°è®¿é—®æµè§ˆå™¨API
        </div>
    </div>

    <div class="test-section">
        <h2>é¢„æœŸæ•ˆæœ</h2>
        <div class="status success">
            <strong>ä¿®å¤åæ•ˆæœ:</strong><br>
            âœ… é¡µé¢å¯ä»¥æ­£å¸¸åŠ è½½ï¼Œæ— SSRé”™è¯¯<br>
            âœ… æ‰€æœ‰åŠŸèƒ½åœ¨å®¢æˆ·ç«¯æ­£å¸¸å·¥ä½œ<br>
            âœ… æœåŠ¡å™¨ç«¯æ¸²æŸ“ä¸ä¼šæŠ¥é”™<br>
            âœ… ç”¨æˆ·ä½“éªŒä¿æŒä¸€è‡´<br>
            âœ… å¼€å‘ä½“éªŒæ›´åŠ ç¨³å®š
        </div>
    </div>

    <script>
        console.log('ğŸ”§ SSRä¿®å¤æµ‹è¯•é¡µé¢å·²åŠ è½½');
        console.log('ğŸ“ ä¿®å¤å†…å®¹:');
        console.log('1. URLæ„é€ å‡½æ•°ä½¿ç”¨ä¿®å¤');
        console.log('2. localStorageè®¿é—®ä¿®å¤');
        console.log('3. documentè®¿é—®ä¿®å¤');
        console.log('4. windowäº‹ä»¶ç›‘å¬å™¨ä¿®å¤');
        console.log('5. window.locationè®¿é—®ä¿®å¤');
    </script>
</body>
</html> 