# R2存储统计功能改进说明

## 问题背景

之前的R2存储统计功能存在以下问题：
1. **统计不准确**: 只统计数据库中的文件记录，不包括R2存储桶中的实际文件
2. **数据不同步**: R2挂载点允许浏览现有文件，但这些文件可能不在数据库中
3. **显示为0字节**: 由于只依赖数据库记录，R2存储使用量经常显示为0

## 解决方案

### 1. 实际R2存储查询

通过Cloudflare R2的S3兼容API（ListObjectsV2）来查询实际的存储使用量：

```typescript
// 遍历所有对象计算实际使用量
const command = new ListObjectsV2Command({
  Bucket: this.config.r2Bucket,
  ContinuationToken: continuationToken,
  MaxKeys: 1000,
})

const response = await this.s3Client.send(command)
// 累计所有对象的大小
```

### 2. 缓存机制

为了避免频繁查询R2 API，实现了智能缓存：

- **缓存时间**: 5分钟TTL
- **自动降级**: 查询失败时使用过期缓存
- **手动刷新**: 管理员可以强制刷新统计

### 3. 错误处理

- **网络错误**: 显示错误信息，使用缓存数据
- **配置错误**: 明确提示R2未配置
- **权限错误**: 显示具体的权限问题

## 新增功能

### 1. 后端API改进

#### 存储统计API (`/admin/stats`)
```json
{
  "totalStorage": 1048576,      // 实际总存储（本地+R2实际）
  "r2Storage": 524288,          // R2实际存储使用量
  "r2Files": 10,                // R2实际文件数量
  "r2StorageInDB": 262144,      // 数据库中的R2记录
  "r2FilesInDB": 5,             // 数据库中的R2文件数
  "localStorage": 524288,       // 本地存储使用量
  "localFiles": 8,              // 本地文件数量
  "r2StorageError": null,       // R2查询错误信息
  "storageType": "r2",          // 当前存储类型
  "enableMixedMode": true       // 是否启用混合模式
}
```

#### 刷新统计API (`/admin/refresh-r2-stats`)
- 清除缓存并强制重新查询R2存储使用量
- 返回最新的统计数据

### 2. 前端界面改进

#### 统计卡片增强
- **R2存储卡片**: 显示实际使用量和错误状态
- **错误指示器**: 查询失败时显示警告图标
- **数据对比**: 显示实际文件数vs数据库记录数

#### 存储分布详情
- **进度条**: 可视化显示存储分布
- **模式标识**: 显示当前存储模式（本地/R2/混合）
- **刷新按钮**: 手动刷新R2统计数据
- **错误提示**: 详细的错误信息和解决建议

### 3. 缓存服务

#### StorageService增强
```typescript
// 带缓存的存储统计
async calculateR2StorageUsage(useCache: boolean = true)

// 清除缓存
clearR2StorageCache()

// 详细统计（包括最大/最小文件）
async getR2StorageStats()
```

## 使用说明

### 1. 管理员操作

#### 查看存储统计
1. 进入管理面板
2. 查看统计卡片中的R2存储使用情况
3. 如果显示错误，检查R2配置

#### 刷新R2统计
1. 在"存储分布详情"卡片中点击"刷新R2统计"按钮
2. 等待查询完成（可能需要几秒钟）
3. 查看更新后的统计数据

#### 故障排除
- **显示"R2 client not configured"**: 检查存储配置中的R2设置
- **显示网络错误**: 检查R2端点和网络连接
- **显示权限错误**: 检查R2访问密钥权限

### 2. 数据解读

#### 统计数据含义
- **R2实际文件数**: R2存储桶中的所有文件
- **R2数据库记录**: 通过应用上传的R2文件
- **差异**: 可能包括直接上传到R2的文件或挂载点文件

#### 正常情况
- R2实际文件数 ≥ R2数据库记录数
- 差异主要来自R2挂载点中的现有文件

#### 异常情况
- R2实际文件数 < R2数据库记录数：可能有文件被直接删除
- 显示错误信息：需要检查R2配置和网络

## 技术细节

### 1. API调用优化

#### 分页查询
```typescript
// 使用分页避免内存问题
do {
  const command = new ListObjectsV2Command({
    Bucket: bucket,
    ContinuationToken: continuationToken,
    MaxKeys: 1000,
  })
  // 处理响应...
} while (continuationToken)
```

#### 错误重试
- 网络错误时使用缓存数据
- 配置错误时返回明确提示
- 权限错误时记录详细日志

### 2. 性能考虑

#### 缓存策略
- **TTL**: 5分钟，平衡实时性和性能
- **降级**: 查询失败时使用过期缓存
- **预热**: 首次查询后自动缓存

#### 查询优化
- **批量处理**: 每次查询1000个对象
- **进度记录**: 大型存储桶显示查询进度
- **异步处理**: 不阻塞其他统计数据

### 3. 监控和日志

#### 详细日志
```
[INFO] R2存储桶使用量计算完成: 150 个文件，总大小: 52428800 字节
[DEBUG] 已处理 1000 个文件，当前总大小: 34567890 字节
[WARN] R2存储统计失败: Network timeout (using cached data)
```

#### 性能监控
- 查询耗时记录
- 缓存命中率统计
- 错误频率监控

## 注意事项

### 1. 性能影响
- 大型存储桶首次查询可能较慢
- 建议在低峰期手动刷新统计
- 缓存机制减少了API调用频率

### 2. 成本考虑
- ListObjectsV2 API有调用费用
- 缓存机制降低了调用频率
- 建议根据需要调整缓存TTL

### 3. 数据一致性
- 统计数据可能有5分钟延迟
- 手动刷新可获取最新数据
- 数据库记录和实际文件可能不同步

## 测试验证

使用提供的测试页面 `test-storage-stats.html` 来验证功能：

1. 配置API地址和管理员Token
2. 点击"测试存储统计"
3. 查看返回的详细统计数据
4. 验证R2存储使用量是否正确显示

## 后续改进

- [ ] 添加存储使用趋势图表
- [ ] 实现存储配额和告警
- [ ] 优化大型存储桶的查询性能
- [ ] 添加存储成本估算功能
- [ ] 实现自动清理过期缓存
