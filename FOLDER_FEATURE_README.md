# 文件夹分类功能说明

## 功能概述

FireflyCloud 现在支持完整的文件夹分类功能，用户可以创建文件夹层级结构来组织和管理文件。

## 新增功能

### 1. 文件夹管理
- **创建文件夹**: 支持在根目录或任意文件夹下创建子文件夹
- **重命名文件夹**: 可以重命名现有文件夹
- **删除文件夹**: 删除空文件夹（包含文件或子文件夹的文件夹需要先清空）
- **文件夹树形结构**: 左侧显示完整的文件夹树，支持展开/折叠

### 2. 文件夹导航
- **面包屑导航**: 显示当前所在文件夹的完整路径
- **快速切换**: 点击面包屑中的任意文件夹名称快速跳转
- **根目录**: 特殊的根目录入口，显示所有根级文件和文件夹

### 3. 文件上传到指定文件夹
- **目标文件夹**: 上传文件时会自动上传到当前选中的文件夹
- **文件夹显示**: 上传界面显示当前目标文件夹路径
- **灵活切换**: 可以随时切换目标文件夹进行上传

### 4. 文件管理增强
- **按文件夹查看**: 文件列表只显示当前文件夹下的文件
- **实时刷新**: 文件夹操作后自动刷新文件列表
- **上下文菜单**: 右键点击文件夹可进行快速操作

## 数据库变更

### 新增表
- **folders**: 存储文件夹信息
  - `id`: 文件夹唯一标识
  - `user_id`: 所属用户ID
  - `name`: 文件夹名称
  - `parent_id`: 父文件夹ID（null表示根文件夹）
  - `path`: 完整路径（便于查询和显示）
  - `created_at`: 创建时间
  - `updated_at`: 更新时间

### 修改表
- **files**: 添加文件夹关联
  - `folder_id`: 所属文件夹ID（null表示根目录文件）

## API 接口

### 文件夹管理
- `GET /folders` - 获取用户的所有文件夹
- `GET /folders/:id/contents` - 获取指定文件夹的内容（子文件夹和文件）
- `POST /folders` - 创建新文件夹
- `PUT /folders/:id` - 重命名文件夹
- `DELETE /folders/:id` - 删除文件夹

### 文件管理增强
- `GET /files?folderId=:id` - 获取指定文件夹下的文件
- `POST /files/upload` - 上传文件（支持 `folderId` 参数）

## 前端组件

### 新增组件
1. **FolderTree** (`components/files/folder-tree.tsx`)
   - 文件夹树形结构显示
   - 支持展开/折叠
   - 右键上下文菜单
   - 文件夹选择和高亮

2. **FolderBreadcrumb** (`components/files/folder-breadcrumb.tsx`)
   - 面包屑导航显示
   - 路径点击跳转
   - 根目录特殊处理

### 修改组件
1. **FileManager** - 集成文件夹功能
   - 左侧文件夹树
   - 右侧文件管理区域
   - 响应式布局

2. **FileUpload** - 支持指定目标文件夹
   - 显示当前目标文件夹
   - 上传时包含文件夹信息

## 使用方法

### 1. 创建文件夹
1. 在文件管理页面左侧点击"新建"按钮
2. 输入文件夹名称
3. 选择父文件夹（可选，默认为根目录）
4. 点击"创建"

### 2. 管理文件夹
1. 右键点击文件夹显示上下文菜单
2. 选择"新建子文件夹"、"重命名"或"删除"
3. 按照提示完成操作

### 3. 上传文件到指定文件夹
1. 在左侧文件夹树中选择目标文件夹
2. 切换到"上传文件"标签页
3. 拖拽或选择文件进行上传
4. 文件将自动上传到选中的文件夹

### 4. 浏览文件
1. 在左侧文件夹树中点击文件夹
2. 右侧文件列表会显示该文件夹下的文件
3. 使用面包屑导航快速跳转到上级文件夹

## 技术特性

- **层级结构**: 支持无限层级的文件夹嵌套
- **路径管理**: 自动维护文件夹的完整路径
- **权限控制**: 用户只能管理自己的文件夹和文件
- **数据一致性**: 删除文件夹时自动处理关联的文件
- **性能优化**: 使用索引和路径字段优化查询性能
- **用户体验**: 响应式设计，支持各种屏幕尺寸

## 安全考虑

- **权限验证**: 所有文件夹操作都验证用户权限
- **名称验证**: 文件夹名称长度和字符限制
- **路径安全**: 防止路径遍历攻击
- **级联删除**: 安全的文件夹删除机制

## R2 挂载点管理

### 管理员功能
- **集中管理**: R2 挂载点管理功能已移动到管理面板中
- **全局视图**: 管理员可以查看和管理所有用户的 R2 挂载点
- **用户分配**: 管理员可以为指定用户创建 R2 挂载点
- **状态控制**: 管理员可以启用/禁用挂载点
- **统一配置**: 在管理面板中统一管理存储配置和挂载点

### 用户体验
- **只读显示**: 普通用户在文件管理界面中只能查看 R2 挂载信息
- **无需配置**: 用户无需了解 R2 配置细节，由管理员统一管理
- **透明使用**: R2 挂载的文件夹对用户来说是透明的，可以正常浏览和操作

## 未来计划

- [ ] 文件夹移动功能
- [ ] 批量文件操作
- [ ] 文件夹共享功能
- [ ] 文件夹大小统计
- [ ] 文件夹搜索功能
- [ ] 文件夹排序选项
- [ ] 拖拽移动文件到文件夹
- [ ] R2 挂载点的自动同步功能
- [ ] 挂载点使用统计和监控

## 兼容性

- 向后兼容：现有的根目录文件不受影响
- 数据迁移：自动添加 `folder_id` 字段，现有文件保持在根目录
- API兼容：现有的文件API继续工作，新增可选的文件夹参数
